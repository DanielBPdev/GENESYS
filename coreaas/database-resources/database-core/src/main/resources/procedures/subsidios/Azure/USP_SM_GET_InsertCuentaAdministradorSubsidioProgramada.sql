-- =============================================
-- Author:		Fabian LÃ³pez
-- Create date: 2020/08/27
-- Description:	Inserta en CuentaAdministradorSubsidioProgramada los datos asociados a los DetalleSubsidioAsignadoProgramado
-- =============================================
CREATE PROCEDURE [dbo].[USP_SM_GET_InsertCuentaAdministradorSubsidioProgramada]	
	@idSolicitudLiquidacion bigint,
	@sUsuario VARCHAR(255)
with execute as owner
AS
BEGIN
BEGIN TRY
	DECLARE @iNumeroRegistros BIGINT,
			@iRevision BIGINT;

	CREATE TABLE #TempCuentaAdminPagos (tmcDispersionMedioDePagoAdmin bigint,tmcFechaHoraCreacionRegistro datetime,tmcUsuarioCreacionRegistro varchar(200),tmcTipoTransaccionSubsidio varchar(40),tmcEstadoTransaccionSubsidio varchar(25),tmcEstadoLiquidacionSubsidio varchar(25),tmcOrigenTransaccion varchar(30),tmcMedioDePagoTransaccion varchar(13),tmcNumeroTarjetaAdmonSubsidio varchar(50),tmcCodigoBanco varchar(7),tmcNombreBanco varchar(255),tmcTipoCuentaAdmonSubsidio varchar(30),tmcNumeroCuentaAdmonSubsidio varchar(30),tmcTipoIdentificacionTitularCuentaAdmonSubsidio varchar(20),tmcNumeroIdentificacionTitularCuentaAdmonSubsidio varchar(20),tmcNombreTitularCuentaAdmonSubsidio varchar(200),tmcFechaHoraTransaccion datetime,tmcUsuarioTransaccion varchar(200),tmcValorOriginalTransaccion numeric(19,5),tmcValorRealTransaccion numeric(19,5),tmcTransaccionOriginal bigint,tmcRemisionDatosTerceroPagador varchar(200),tmcTransaccionTerceroPagador varchar(200),tmcNombreTerceroPagado varchar(200),tmcCuentaAdmonSubsidioRelacionado bigint,tmcFechaHoraUltimaModificacion datetime,tmcUsuarioUltimaModificacion varchar(200),tmcAdministradorSubsidio bigint,tmcSitioDePago bigint,tmcSitioDeCobro bigint,tmcMedioDePago bigint,tmcCondicionPersonaAdministradorSubsidio bigint,s1 varchar(500),s2 varchar(500), idSolicitud bigint);
	DECLARE @TempCuentaAdminPagosIns table(capId bigint,capFechaHoraCreacionRegistro datetime,capUsuarioCreacionRegistro varchar(200),capTipoTransaccionSubsidio varchar(40),capEstadoTransaccionSubsidio varchar(25),capEstadoLiquidacionSubsidio varchar(25),capOrigenTransaccion varchar(30),capMedioDePagoTransaccion varchar(13),capNumeroTarjetaAdmonSubsidio varchar(50),capCodigoBanco varchar(7),capNombreBanco varchar(255),capTipoCuentaAdmonSubsidio varchar(30),capNumeroCuentaAdmonSubsidio varchar(30),capTipoIdentificacionTitularCuentaAdmonSubsidio varchar(20),capNumeroIdentificacionTitularCuentaAdmonSubsidio varchar(20),capNombreTitularCuentaAdmonSubsidio varchar(200),capFechaHoraTransaccion datetime,capUsuarioTransaccion varchar(200),capValorOriginalTransaccion numeric(19,5),capValorRealTransaccion numeric(19,5),capIdTransaccionOriginal bigint,capIdRemisionDatosTerceroPagador varchar(200),capIdTransaccionTerceroPagador varchar(200),capNombreTerceroPagado varchar(200),capIdCuentaAdmonSubsidioRelacionado bigint,capFechaHoraUltimaModificacion datetime,capUsuarioUltimaModificacion varchar(200),capAdministradorSubsidio bigint,capSitioDePago bigint,capSitioDeCobro bigint,capMedioDePago bigint,capSolicitudLiquidacionSubsidio bigint,capCondicionPersonaAdmin bigint);
	
	INSERT #TempCuentaAdminPagos (tmcFechaHoraCreacionRegistro,tmcUsuarioCreacionRegistro,tmcTipoTransaccionSubsidio,tmcEstadoTransaccionSubsidio,tmcEstadoLiquidacionSubsidio,tmcOrigenTransaccion,tmcMedioDePagoTransaccion,tmcNumeroTarjetaAdmonSubsidio,tmcCodigoBanco,tmcNombreBanco,tmcTipoCuentaAdmonSubsidio,tmcNumeroCuentaAdmonSubsidio,tmcTipoIdentificacionTitularCuentaAdmonSubsidio,tmcNumeroIdentificacionTitularCuentaAdmonSubsidio,tmcNombreTitularCuentaAdmonSubsidio,tmcFechaHoraTransaccion,tmcUsuarioTransaccion,tmcValorOriginalTransaccion,tmcValorRealTransaccion,tmcTransaccionOriginal,tmcRemisionDatosTerceroPagador,tmcTransaccionTerceroPagador,tmcNombreTerceroPagado,tmcCuentaAdmonSubsidioRelacionado,tmcFechaHoraUltimaModificacion,tmcUsuarioUltimaModificacion,tmcAdministradorSubsidio,tmcSitioDePago,tmcSitioDeCobro,tmcMedioDePago,idSolicitud,tmcCondicionPersonaAdministradorSubsidio,s1)
	EXEC sp_execute_remote SubsidioReferenceData, 
	N'SELECT tmcFechaHoraCreacionRegistro,tmcUsuarioCreacionRegistro,tmcTipoTransaccionSubsidio,tmcEstadoTransaccionSubsidio,tmcEstadoLiquidacionSubsidio,tmcOrigenTransaccion,tmcMedioDePagoTransaccion,tmcNumeroTarjetaAdmonSubsidio,tmcCodigoBanco,tmcNombreBanco,tmcTipoCuentaAdmonSubsidio,tmcNumeroCuentaAdmonSubsidio,tmcTipoIdentificacionTitularCuentaAdmonSubsidio,tmcNumeroIdentificacionTitularCuentaAdmonSubsidio,tmcNombreTitularCuentaAdmonSubsidio,tmcFechaHoraTransaccion,tmcUsuarioTransaccion,tmcValorOriginalTransaccion,tmcValorRealTransaccion,tmcTransaccionOriginal,tmcRemisionDatosTerceroPagador,tmcTransaccionTerceroPagador,tmcNombreTerceroPagado,tmcCuentaAdmonSubsidioRelacionado,tmcFechaHoraUltimaModificacion,tmcUsuarioUltimaModificacion,tmcAdministradorSubsidio,tmcSitioDePago,tmcSitioDeCobro,tmcMedioDePago,@idSolicitudLiquidacion,tmcCondicionPersonaAdministradorSubsidio
	  FROM TempCuentaAdminPagos t',
	  	N'@idSolicitudLiquidacion bigint',
 		@idSolicitudLiquidacion=@idSolicitudLiquidacion;	

	INSERT CuentaAdministradorSubsidioProgramada (capFechaHoraCreacionRegistro,capUsuarioCreacionRegistro,capTipoTransaccionSubsidio,capEstadoTransaccionSubsidio,capEstadoLiquidacionSubsidio,capOrigenTransaccion,capMedioDePagoTransaccion,capNumeroTarjetaAdmonSubsidio,capCodigoBanco, capNombreBanco,capTipoCuentaAdmonSubsidio,capNumeroCuentaAdmonSubsidio,capTipoIdentificacionTitularCuentaAdmonSubsidio,capNumeroIdentificacionTitularCuentaAdmonSubsidio,capNombreTitularCuentaAdmonSubsidio,capFechaHoraTransaccion,capUsuarioTransaccion,capValorOriginalTransaccion,capValorRealTransaccion,capIdTransaccionOriginal,capIdRemisionDatosTerceroPagador,capIdTransaccionTerceroPagador,capNombreTerceroPagado,capIdCuentaAdmonSubsidioRelacionado,capFechaHoraUltimaModificacion,capUsuarioUltimaModificacion,capAdministradorSubsidio,capSitioDePago,capSitioDeCobro,capMedioDePago,capSolicitudLiquidacionSubsidio,capCondicionPersonaAdmin)
	OUTPUT INSERTED.capId,INSERTED.capFechaHoraCreacionRegistro,INSERTED.capUsuarioCreacionRegistro,INSERTED.capTipoTransaccionSubsidio,INSERTED.capEstadoTransaccionSubsidio,INSERTED.capEstadoLiquidacionSubsidio,INSERTED.capOrigenTransaccion,INSERTED.capMedioDePagoTransaccion,INSERTED.capNumeroTarjetaAdmonSubsidio,INSERTED.capCodigoBanco, INSERTED.capNombreBanco,INSERTED.capTipoCuentaAdmonSubsidio,INSERTED.capNumeroCuentaAdmonSubsidio,INSERTED.capTipoIdentificacionTitularCuentaAdmonSubsidio,INSERTED.capNumeroIdentificacionTitularCuentaAdmonSubsidio,INSERTED.capNombreTitularCuentaAdmonSubsidio,INSERTED.capFechaHoraTransaccion,INSERTED.capUsuarioTransaccion,INSERTED.capValorOriginalTransaccion,INSERTED.capValorRealTransaccion,INSERTED.capIdTransaccionOriginal,INSERTED.capIdRemisionDatosTerceroPagador,INSERTED.capIdTransaccionTerceroPagador,INSERTED.capNombreTerceroPagado,INSERTED.capIdCuentaAdmonSubsidioRelacionado,INSERTED.capFechaHoraUltimaModificacion,INSERTED.capUsuarioUltimaModificacion,INSERTED.capAdministradorSubsidio,INSERTED.capSitioDePago,INSERTED.capSitioDeCobro,INSERTED.capMedioDePago,INSERTED.capSolicitudLiquidacionSubsidio,INSERTED.capCondicionPersonaAdmin
	INTO @TempCuentaAdminPagosIns
	--(capFechaHoraCreacionRegistro,capUsuarioCreacionRegistro,capTipoTransaccionSubsidio,capEstadoTransaccionSubsidio,capEstadoLiquidacionSubsidio,capOrigenTransaccion,capMedioDePagoTransaccion,capNumeroTarjetaAdmonSubsidio,capCodigoBanco, capNombreBanco,capTipoCuentaAdmonSubsidio,capNumeroCuentaAdmonSubsidio,capTipoIdentificacionTitularCuentaAdmonSubsidio,capNumeroIdentificacionTitularCuentaAdmonSubsidio,capNombreTitularCuentaAdmonSubsidio,capFechaHoraTransaccion,capUsuarioTransaccion,capValorOriginalTransaccion,capValorRealTransaccion,capIdTransaccionOriginal,capIdRemisionDatosTerceroPagador,capIdTransaccionTerceroPagador,capNombreTerceroPagado,capIdCuentaAdmonSubsidioRelacionado,capFechaHoraUltimaModificacion,capUsuarioUltimaModificacion,capAdministradorSubsidio,capSitioDePago,capSitioDeCobro,capMedioDePago,capSolicitudLiquidacionSubsidio,capCondicionPersonaAdmin)
	SELECT max(tmcFechaHoraCreacionRegistro),tmcUsuarioCreacionRegistro,tmcTipoTransaccionSubsidio,tmcEstadoTransaccionSubsidio,tmcEstadoLiquidacionSubsidio,tmcOrigenTransaccion,tmcMedioDePagoTransaccion,tmcNumeroTarjetaAdmonSubsidio,tmcCodigoBanco,tmcNombreBanco,tmcTipoCuentaAdmonSubsidio,tmcNumeroCuentaAdmonSubsidio,tmcTipoIdentificacionTitularCuentaAdmonSubsidio,tmcNumeroIdentificacionTitularCuentaAdmonSubsidio,tmcNombreTitularCuentaAdmonSubsidio,max(tmcFechaHoraTransaccion),tmcUsuarioTransaccion,sum(tmcValorOriginalTransaccion) tmcValorOriginalTransaccion,sum(tmcValorRealTransaccion) tmcValorRealTransaccion,tmcTransaccionOriginal,tmcRemisionDatosTerceroPagador,tmcTransaccionTerceroPagador,tmcNombreTerceroPagado,tmcCuentaAdmonSubsidioRelacionado,max(tmcFechaHoraUltimaModificacion),tmcUsuarioUltimaModificacion,tmcAdministradorSubsidio,max(tmcSitioDePago),tmcSitioDeCobro,max(tmcMedioDePago) tmcMedioDePago,idSolicitud,tmcCondicionPersonaAdministradorSubsidio
	FROM #TempCuentaAdminPagos
	GROUP BY tmcUsuarioCreacionRegistro,tmcTipoTransaccionSubsidio,tmcEstadoTransaccionSubsidio,tmcEstadoLiquidacionSubsidio,tmcOrigenTransaccion,tmcMedioDePagoTransaccion,tmcNumeroTarjetaAdmonSubsidio,tmcCodigoBanco,tmcNombreBanco,tmcTipoCuentaAdmonSubsidio,tmcNumeroCuentaAdmonSubsidio,tmcTipoIdentificacionTitularCuentaAdmonSubsidio,tmcNumeroIdentificacionTitularCuentaAdmonSubsidio,tmcNombreTitularCuentaAdmonSubsidio,tmcUsuarioTransaccion,tmcTransaccionOriginal,tmcRemisionDatosTerceroPagador,tmcTransaccionTerceroPagador,tmcNombreTerceroPagado,tmcCuentaAdmonSubsidioRelacionado,tmcUsuarioUltimaModificacion,tmcAdministradorSubsidio,tmcSitioDeCobro,idSolicitud,tmcCondicionPersonaAdministradorSubsidio


	SELECT @iNumeroRegistros = COUNT(*) FROM #TempCuentaAdminPagos

	IF @iNumeroRegistros > 0
	BEGIN
		EXEC [dbo].[USP_UTIL_GET_CrearRevision] 'com.asopagos.entidades.subsidiomonetario.pagos.CuentaAdministradorSubsidio',@iNumeroRegistros,'',@sUsuario,@iRevision OUTPUT

		INSERT INTO aud.CuentaAdministradorSubsidioProgramada_aud (capId,capFechaHoraCreacionRegistro,capUsuarioCreacionRegistro,capTipoTransaccionSubsidio,capEstadoTransaccionSubsidio,capEstadoLiquidacionSubsidio,capOrigenTransaccion,capMedioDePagoTransaccion,capNumeroTarjetaAdmonSubsidio,capCodigoBanco, capNombreBanco,capTipoCuentaAdmonSubsidio,capNumeroCuentaAdmonSubsidio,capTipoIdentificacionTitularCuentaAdmonSubsidio,capNumeroIdentificacionTitularCuentaAdmonSubsidio,capNombreTitularCuentaAdmonSubsidio,capFechaHoraTransaccion,capUsuarioTransaccion,capValorOriginalTransaccion,capValorRealTransaccion,capIdTransaccionOriginal,capIdRemisionDatosTerceroPagador,capIdTransaccionTerceroPagador,capNombreTerceroPagado,capIdCuentaAdmonSubsidioRelacionado,capFechaHoraUltimaModificacion,capUsuarioUltimaModificacion,capAdministradorSubsidio,capSitioDePago,capSitioDeCobro,capMedioDePago,capSolicitudLiquidacionSubsidio,capCondicionPersonaAdmin,REV,REVTYPE)
		SELECT capId,capFechaHoraCreacionRegistro,capUsuarioCreacionRegistro,capTipoTransaccionSubsidio,capEstadoTransaccionSubsidio,capEstadoLiquidacionSubsidio,capOrigenTransaccion,capMedioDePagoTransaccion,capNumeroTarjetaAdmonSubsidio,capCodigoBanco,capNombreBanco,capTipoCuentaAdmonSubsidio,capNumeroCuentaAdmonSubsidio,capTipoIdentificacionTitularCuentaAdmonSubsidio,capNumeroIdentificacionTitularCuentaAdmonSubsidio,capNombreTitularCuentaAdmonSubsidio,capFechaHoraTransaccion,capUsuarioTransaccion,capValorOriginalTransaccion,capValorRealTransaccion,capIdTransaccionOriginal,capIdRemisionDatosTerceroPagador,capIdTransaccionTerceroPagador,capNombreTerceroPagado,capIdCuentaAdmonSubsidioRelacionado,capFechaHoraUltimaModificacion,capUsuarioUltimaModificacion,capAdministradorSubsidio,capSitioDePago,capSitioDeCobro,capMedioDePago,capSolicitudLiquidacionSubsidio,capCondicionPersonaAdmin,@iRevision,0
		FROM @TempCuentaAdminPagosIns
	END

	EXEC sp_execute_remote SubsidioReferenceData, 
	N'UPDATE dmp
		SET dmpEnviadoAPagos = 1
		FROM dbo.DispersionMedioDePagoAdmin dmp
		JOIN TempCuentaAdminPagos t on t.tmcDispersionMedioDePagoAdmin =dmp.dmpId'	

END TRY
BEGIN CATCH
	INSERT RegistroLog (relFecha,relParametrosEjecucion,relErrorMessage)
	VALUES (dbo.GetLocalDate(),'[USP_SM_GET_InsertCuentaAdministradorSubsidioProgramada] ' ,ERROR_MESSAGE());
END CATCH
	print 'Finaliza USP_SM_GET_InsertCuentaAdministradorSubsidioProgramada'
END ;


